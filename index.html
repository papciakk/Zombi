<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Game</title>
		
		<style>
			html, body {
				width: 100%;
				height: 100%;
			}

			body {
				background-color: #ffffff;
				margin: 0;
				overflow: hidden;
				font-family: arial;
			}

			#blocker {

				position: absolute;

				width: 100%;
				height: 100%;

				background-color: rgba(0,0,0,0.5);

			}

			#instructions {

				width: 100%;
				height: 100%;

				display: -webkit-box;
				display: -moz-box;
				display: box;

				-webkit-box-orient: horizontal;
				-moz-box-orient: horizontal;
				box-orient: horizontal;

				-webkit-box-pack: center;
				-moz-box-pack: center;
				box-pack: center;

				-webkit-box-align: center;
				-moz-box-align: center;
				box-align: center;

				color: #ffffff;
				text-align: center;

				cursor: pointer;

			}
			
			.cross_cursor {
				position: absolute;
				left: 0;
				right: 0;
				margin-left: auto;
				margin-right: auto;
				top: 0;
				bottom: 0;
				margin-top: auto;
				margin-bottom: auto;
				width:18px;
			}
		</style>		
	</head>
	<body>
		<div id="blocker">

			<div id="instructions">
				<span style="font-size:40px">Click to play</span>
				<br />
				(W, A, S, D = Move, SPACE = Jump, MOUSE = Look around)
			</div>

		</div>
		
		<img src="cross.png" class="cross_cursor"/>


		
		<script src="jquery-1.9.0.js"></script>
		<script src="three.js"></script>
		<script src="collada/Animation.js"></script>
		<script src="collada/AnimationHandler.js"></script>
		<script src="collada/KeyFrameAnimation.js"></script>
		<script src="ColladaLoader.js"></script>
		<script src="PointerLockControls.js"></script>
		<script src='THREEx.KeyboardState.js'></script>
		<script src='stats.min.js'></script>
		
		<script src='promise.min.js'></script>
		<script src='pngtoy.min.js'></script>
		
		
		<script>
			var skinnedMesh, animation;
			var controls;
			var zombieSpawner;

            var emitter, particleGroup;
            var zombie;
            var zombie1;
			
			var clock = new THREE.Clock();
			var keyboard = new THREEx.KeyboardState();
			
			var raycaster = new THREE.Raycaster();
			var mouse = new THREE.Vector2();

            function getPlayerPosition() {
                return controls.getObject().position;
            }


            function onMouseMove(event) {
				mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
				mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;
			}
			
			window.addEventListener('mousemove', onMouseMove, false);
			
		</script>
		
		<script src='pointerLock.js'></script>
		<script src='skybox.js'></script>
		
		<script src='ZombieSpawner.js'></script>
		<script src='Zombie.js'></script>
		<script src='ZombieAI.js'></script>

        <script type="text/javascript" src="SPE.min.js"></script>
		
		
		<script>
			$(function () {



                function initParticles() {
                    particleGroup = new SPE.Group({
                        texture: {
                            value: THREE.ImageUtils.loadTexture('exp.png')
                        }
                    });

                    emitter = new SPE.Emitter({
                        maxAge: {
                            value: 1
                        },
                        position: {
                            value: new THREE.Vector3(0, 0, 0),
                            spread: new THREE.Vector3(20, 20, 20 )
                        },

                        acceleration: {
                            value: new THREE.Vector3(-10, -10, -10),
                            spread: new THREE.Vector3( 100, 100, 100 )
                        },

                        velocity: {
                            value: new THREE.Vector3(10, 10, 10),
                            spread: new THREE.Vector3(100, 7.5, 100)
                        },

                        color: {
                            value: [ new THREE.Color('white'), new THREE.Color('red') ]
                        },

                        size: {
                            value: 100
                        },

                        particleCount: 2000
                    });

                    particleGroup.addEmitter( emitter );
                    scene.add( particleGroup.mesh );

                }
			
				// stats
				var stats = new Stats();
				stats.showPanel(0);
				document.body.appendChild( stats.dom );


				var texLoader = new THREE.TextureLoader();
			
			
				function loadTex(filename, repeat) {
					var texture = texLoader.load(filename); 
					texture.wrapS = THREE.RepeatWrapping; 
					texture.wrapT = THREE.RepeatWrapping; 
					texture.repeat.set(repeat, repeat);
					
					return texture;
				}
			
			
				var scene = new THREE.Scene();
				var camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 10000000);
				var renderer = new THREE.WebGLRenderer();

				renderer.setClearColor(new THREE.Color(0xEEEEEE, 1.0));
				renderer.setSize(window.innerWidth, window.innerHeight);
				// renderer.shadowMapEnabled = true;

				controls = new THREE.PointerLockControls( camera );
				scene.add( controls.getObject() );

				


				// skybox 
				addSkybox(scene, "skybox");

                //initParticles();
				
				
				
				
				
				var geometry = new THREE.PlaneGeometry( 20000, 20000, 1, 1 );
				
				var ground_diffuse = loadTex("textures/grass2.jpg", 200); 
				ground_diffuse.anisotropy = 8;
				//var dirt_normal = loadTex("dirt_norm.png", 10); 
				//var dirt_specular = loadTex("dirt_spec.png", 10); 
				
				//material = new THREE.MeshPhongMaterial( {
				//	shininess: 30,
				//	map: ground_diffuse,
					//normalMap: dirt_normal,
					//specularMap: dirt_specular
				//} );

				var material = new THREE.MeshBasicMaterial ({
					map: ground_diffuse
				});

				var mesh = new THREE.Mesh( geometry, material );
				mesh.rotateX(-Math.PI/2.0);
				scene.add( mesh );
				
				
				
				zombieSpawner = new ZombieSpawner(scene);
                zombieSpawner.init().then(function() {
                    for(var i=0; i< 20; i++) {
                        zombieSpawner.spawn(Math.random()*2000-1000, Math.random()*2000-1000);
                    }
                    zombie = zombieSpawner.spawn();
					//zombie1 = zombieSpawner.spawn();
                });

				
			/*
				var dataObj;
				var img = new PngImage();
				var buffer;

				img.onload = function() {
					var pngtoy = this.pngtoy;
					dataObj = pngtoy.decode().then(function(results) {

						buffer = new Uint16Array(results.bitmap);

						for(var i = 0, j; i < buffer.length; i++) {

						  j = buffer[i];
						  buffer[i] = ((j & 0xff) << 8) | ((j & 0xff00) >>> 8); // needed to swap bytes for correct unsigned integer values  
						}

						console.log(buffer);
					});     
				};

				img.onerror = function(e) {
					console.log(e.message);
				};

				img.src = "heightmap.png";
				
			*/
				/*
			"use strict";
			
			var heightmap_data;
			
			var png = new PngToy();
			png.fetch("heightmap.png").then(() => {
				png.decode().then((bmp) => {
					heightmap_data = new Uint16Array(bmp.bitmap);
					
					for(var i=0, j; i<heightmap_data.length; i++) {
						j = heightmap_data[i];
						heightmap_data[i] = ((j & 0xff) << 8) | ((j & 0xff00) >>> 8);
					}
				})
			});*/

			

				
				
				var tex_diffuse = loadTex("textures/handgun/handgun_C.jpg", 1);
				var tex_specular = loadTex("textures/handgun/handgun_S.jpg", 1); 
				var tex_normal = loadTex("textures/handgun/handgun_N.jpg", 1);
				
				var gun;
				var loader = new THREE.JSONLoader();
				loader.load(
					'handgun.json',
					function (geometry, materials) {

						var material = new THREE.MeshPhongMaterial({map: tex_diffuse, specularMap: tex_specular, normalMap: tex_normal, shininess: 60});
												
						gun = new THREE.Mesh(geometry, material);
						gun.rotateY(Math.PI/2);
						gun.rotateX(-Math.PI/2);						
						gun.position.set(4, -4, -8);
						camera.add(gun);
					}
				);
			
				
				
				
				camera.position.x = 0;
				camera.position.y = 0;
				camera.position.z = 0;
				camera.lookAt(new THREE.Vector3(0, 0, 0));

				var ambiColor = "#444444";
				var ambientLight = new THREE.AmbientLight(ambiColor);
				scene.add(ambientLight);
				
				var sun = new THREE.PointLight(0xffffff);
				sun.position.set(0, 500000, 500000);

				scene.add( sun );
				
				
				var cameraLight = new THREE.DirectionalLight(0x666655);
				camera.add( cameraLight );

				
				
				renderer = new THREE.WebGLRenderer();
				renderer.setClearColor( 0xffffff );
				renderer.setSize( window.innerWidth, window.innerHeight );

				document.body.appendChild( renderer.domElement );

				//

				window.addEventListener( 'resize', onWindowResize, false );


				function onWindowResize() {

					camera.aspect = window.innerWidth / window.innerHeight;
					camera.updateProjectionMatrix();

					renderer.setSize( window.innerWidth, window.innerHeight );

				}

				
				
			animate();
				
			var shooting = false;
				
			function animate() {

				stats.begin();
				
				if(gun) {
					if(shooting) {
						gun.position.z = -7.9;
						gun.rotation.x = -Math.PI/2 + Math.PI/64;
						shooting = false;
					} else {
						gun.position.z = -8;
						gun.rotation.x = -Math.PI/2;
					}
				}
				
			
				requestAnimationFrame( animate );
				render();
				
				stats.end();
			}


			function render() {

				if(zombie) {
					zombie.aimed = false;
					raycaster.set( controls.getObject().position, camera.getWorldDirection() );
					var intersects = raycaster.intersectObjects( [zombie.getMesh()], true);
					
					for ( var i = 0; i < intersects.length; i++ ) {
						zombie.aimed = true;
					}
				}
				
				
				
				var delta = clock.getDelta();

                zombieSpawner.updateZombies(delta);
				
                //particleGroup.tick( delta);
				
				controls.update(delta*1000);
				THREE.AnimationHandler.update(delta);

				renderer.render( scene, camera );
				
				
				
				handleControls();
			}
				
			
			function handleControls() {
					if(keyboard.pressed("z")) {
						shooting = true;
						if(zombie.aimed) {
							zombie.hit();
						}
					}
					
					
					if(keyboard.pressed("1")) {
						zombie.playAni("idle1");
					}
					if(keyboard.pressed("2")) {
						zombie.playAni("idle2");
					}
					if(keyboard.pressed("3")) {
						zombie.playAni("walk1");
					}
					if(keyboard.pressed("4")) {
						zombie.playAni("walk2");
					}
					if(keyboard.pressed("5")) {
						zombie.playAni("run");
					}
					if(keyboard.pressed("6")) {
						zombie.playAni("attack1");
					}
					if(keyboard.pressed("7")) {
						zombie.playAni("attack2");
					}
					if(keyboard.pressed("8")) {
						zombie.playAni("hit");
					}
					if(keyboard.pressed("9")) {
						zombie.playAni("die");
					}
					
					if(keyboard.pressed("g")) {
						zombie.run(new THREE.Vector2(Math.random()*2000-1000, Math.random()*2000-1000));
					}
			}

				

			});
		</script>
	</body>
</html>
